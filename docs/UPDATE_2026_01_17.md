# Update 17 Januari 2026

## Ringkasan Perubahan

Dokumen ini menjelaskan perubahan yang dilakukan pada sistem SyncFlow pada tanggal 17 Januari 2026. Terdapat 3 perubahan utama yang dilakukan.

---

## 1. Perbaikan Endpoint `/reports/data` - Exclude SKIP_CHECK dari Summary Todo

### Masalah
Endpoint `/reports/data` menghitung semua measurement item dengan status `null` sebagai `todo` di summary, termasuk item yang memiliki `evaluation_type` = `SKIP_CHECK`. Padahal item dengan `SKIP_CHECK` seharusnya tidak dihitung sebagai todo karena memang tidak perlu di-check.

### Solusi
Endpoint sekarang mengecek `evaluation_type` dari setiap measurement point. Jika `evaluation_type` adalah `SKIP_CHECK`, maka item tersebut tidak akan dihitung dalam `summary.todo`, meskipun statusnya `null`.

### Endpoint Terpengaruh
- **GET** `/api/v1/reports/data`

### Parameter
- `quarter` (required): Quarter number (1-4)
- `year` (required): Tahun
- `product_id` (required): ID produk
- `batch_number` (required): Nomor batch

### Response Structure
Response tetap sama, namun perhitungan `summary.todo` sekarang sudah benar:
- `summary.todo`: Hanya menghitung item yang benar-benar belum diukur (bukan SKIP_CHECK)

### Contoh Kasus
Sebelumnya, jika ada 3 measurement item dengan `SKIP_CHECK` (diameter_wire_x, diameter_wire_y, berat), ketiganya akan masuk ke `summary.todo`. Sekarang, ketiga item tersebut tidak akan dihitung dalam `summary.todo`.

### Contoh Request & Response

**Request:**
```
GET /api/v1/reports/data?quarter=1&year=2026&product_id=PRD-MX5C2OCE&batch_number=12345676
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Report data retrieved successfully",
  "error_id": null,
  "data": {
    "product": {
      "product_id": "PRD-MX5C2OCE",
      "product_name": "CIVUS",
      "product_spec_name": "CIVUS 0.75 G Alternative",
      "product_category": "Wire Test Reguler",
      "article_code": "1801R704060",
      "no_document": "QA/4-2033/2012",
      "no_doc_reference": "YPES-11-01-254"
    },
    "measurement_items": [
      {
        "name": "JUMLAH CORE",
        "name_id": "jumlah_core",
        "type": "QUANTITATIVE",
        "status": true
      },
      {
        "name": "DIAMETER WIRE X",
        "name_id": "diameter_wire_x",
        "type": "QUANTITATIVE",
        "status": null
      },
      {
        "name": "DIAMETER WIRE Y",
        "name_id": "diameter_wire_y",
        "type": "QUANTITATIVE",
        "status": null
      },
      {
        "name": "BERAT",
        "name_id": "berat",
        "type": "QUANTITATIVE",
        "status": null
      }
    ],
    "summary": {
      "measurement_passed": 1,
      "measurement_failed": 0,
      "measurement_ok": 8,
      "measurement_ng": 0,
      "todo": 0
    }
  }
}
```

**Catatan:** 
- Item `diameter_wire_x`, `diameter_wire_y`, dan `berat` memiliki `status: null` karena `evaluation_type: SKIP_CHECK`
- `summary.todo` sekarang adalah `0` (bukan `3`) karena item SKIP_CHECK tidak dihitung

---

## 2. Penambahan Filter `category_id` dan Search Query

### Perubahan
Tiga endpoint `available-products` sekarang mendukung filter berdasarkan `category_id` dan pencarian menggunakan parameter `query`.

### Endpoint yang Diupdate

#### 2.1. `/product-measurement/available-products`
**Method:** GET  
**Deskripsi:** Mendapatkan daftar produk yang tersedia untuk membuat target bulanan baru (belum punya measurement di quarter yang dipilih)

**Parameter Baru:**
- `category_id` (optional): Filter berdasarkan ID kategori produk
- `query` (optional): Pencarian berdasarkan nama produk, product_spec_name, product_id, article_code, atau ref_spec_number

**Parameter Existing:**
- `quarter` (required): Quarter number (1-4)
- `year` (required): Tahun
- `page` (optional): Nomor halaman
- `limit` (optional): Jumlah item per halaman

**Contoh Request & Response:**

**Request (dengan filter):**
```
GET /api/v1/product-measurement/available-products?quarter=1&year=2026&category_id=1&query=CIVUS&page=1&limit=10
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Available products retrieved successfully",
  "error_id": null,
  "data": [
    {
      "id": "PRD-MX5C2OCE",
      "product_category_id": 1,
      "product_category_name": "Wire Test Reguler",
      "product_name": "CIVUS",
      "product_spec_name": "CIVUS 0.75 G Alternative",
      "ref_spec_number": "YPES-11-01-254",
      "nom_size_vo": "0.75",
      "article_code": "1801R704060",
      "no_document": "QA/4-2033/2012",
      "no_doc_reference": "YPES-11-01-254",
      "color": null,
      "size": null
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_page": 1,
    "limit": 10,
    "total_docs": 1
  }
}
```

**Request (tanpa filter - backward compatible):**
```
GET /api/v1/product-measurement/available-products?quarter=1&year=2026&page=1&limit=10
```

**Response:** Format sama, menampilkan semua available products tanpa filter

#### 2.2. `/reports/filters/products`
**Method:** GET  
**Deskripsi:** Mendapatkan daftar produk yang memiliki measurement di quarter tertentu (untuk filter di halaman reports)

**Parameter Baru:**
- `category_id` (optional): Filter berdasarkan ID kategori produk
- `query` (optional): Pencarian berdasarkan nama produk, product_spec_name, product_id, article_code, atau ref_spec_number

**Parameter Existing:**
- `quarter` (required): Quarter number (1-4)
- `year` (required): Tahun

**Contoh Request & Response:**

**Request (dengan filter):**
```
GET /api/v1/reports/filters/products?quarter=1&year=2026&category_id=1&query=CIVUS
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Products retrieved successfully",
  "error_id": null,
  "data": [
    {
      "product_id": "PRD-MX5C2OCE",
      "product_name": "CIVUS",
      "product_spec_name": "CIVUS 0.75 G Alternative",
      "product_category": "Wire Test Reguler"
    }
  ]
}
```

**Request (tanpa filter - backward compatible):**
```
GET /api/v1/reports/filters/products?quarter=1&year=2026
```

**Response:** Format sama, menampilkan semua products yang punya measurement di quarter tersebut

#### 2.3. `/scale-measurement/available-products`
**Method:** GET  
**Deskripsi:** Mendapatkan daftar produk yang tersedia untuk membuat scale measurement baru (belum punya measurement di tanggal tertentu)

**Parameter Baru:**
- `category_id` (optional): Filter berdasarkan ID kategori produk
- `query` (optional): Pencarian berdasarkan nama produk, product_spec_name, product_id, article_code, atau ref_spec_number

**Parameter Existing:**
- `date` (required): Tanggal measurement
- `page` (optional): Nomor halaman
- `limit` (optional): Jumlah item per halaman

**Contoh Request & Response:**

**Request (dengan filter):**
```
GET /api/v1/scale-measurement/available-products?date=2026-01-17&category_id=1&query=CIVUS&page=1&limit=10
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Available products retrieved successfully",
  "error_id": null,
  "data": [
    {
      "id": "PRD-MX5C2OCE",
      "product_category_id": 1,
      "product_category_name": "Wire Test Reguler",
      "product_name": "CIVUS",
      "product_spec_name": "CIVUS 0.75 G Alternative",
      "ref_spec_number": "YPES-11-01-254",
      "nom_size_vo": "0.75",
      "article_code": "1801R704060",
      "no_document": "QA/4-2033/2012",
      "no_doc_reference": "YPES-11-01-254"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_page": 1,
    "limit": 10,
    "total_docs": 1
  }
}
```

**Request (tanpa filter - backward compatible):**
```
GET /api/v1/scale-measurement/available-products?date=2026-01-17&page=1&limit=10
```

**Response:** Format sama, menampilkan semua available products tanpa filter

### Catatan Penting
- Filter `category_id` dan `query` bersifat optional, sehingga tidak akan mempengaruhi behavior existing jika tidak digunakan
- Pencarian `query` akan mencari di field: `product_spec_name`, `product_name`, `product_id`, `article_code`, dan `ref_spec_number`
- Filter `category_id` harus sesuai dengan ID yang ada di tabel `product_categories`

---

## 3. Penambahan Field `device_id` pada Tools

### Perubahan
Field baru `device_id` ditambahkan ke semua endpoint terkait tools. Field ini **required** saat create tool baru dan dapat digunakan untuk menyimpan identifier device tambahan selain IMEI.

### Endpoint yang Diupdate

#### 3.1. GET `/api/v1/tools`
**Method:** GET  
**Deskripsi:** Mendapatkan daftar semua tools

**Perubahan:**
- Response sekarang termasuk field `device_id`
- Parameter `search` sekarang juga mencari di field `device_id`

**Response Field Baru:**
- `device_id`: String, required

**Contoh Request & Response:**

**Request:**
```
GET /api/v1/tools?page=1&limit=10&search=DEVICE123
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Tools retrieved successfully",
  "error_id": null,
  "data": [
    {
      "id": 1,
      "tool_name": "Digital Caliper",
      "tool_model": "DC-2000",
      "tool_type": "MECHANICAL",
      "tool_type_description": "Mechanical Tool",
      "last_calibration_at": "2025-12-01",
      "next_calibration_at": "2026-06-01",
      "imei": "IMEI-123456",
      "device_id": "DEVICE-001",
      "status": "ACTIVE",
      "status_description": "Active",
      "created_at": "2025-01-15T10:30:00.000000Z",
      "updated_at": "2026-01-17T08:00:00.000000Z"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_page": 1,
    "limit": 10,
    "total_docs": 1
  }
}
```

#### 3.2. GET `/api/v1/tools/{id}`
**Method:** GET  
**Deskripsi:** Mendapatkan detail tool berdasarkan ID

**Perubahan:**
- Response sekarang termasuk field `device_id`

**Response Field Baru:**
- `device_id`: String, required

**Contoh Request & Response:**

**Request:**
```
GET /api/v1/tools/1
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Tool retrieved successfully",
  "error_id": null,
  "data": {
    "id": 1,
    "tool_name": "Digital Caliper",
    "tool_model": "DC-2000",
    "tool_type": "MECHANICAL",
    "tool_type_description": "Mechanical Tool",
    "last_calibration_at": "2025-12-01",
    "next_calibration_at": "2026-06-01",
    "imei": "IMEI-123456",
    "device_id": "DEVICE-001",
    "status": "ACTIVE",
    "status_description": "Active",
    "created_at": "2025-01-15T10:30:00.000000Z",
    "updated_at": "2026-01-17T08:00:00.000000Z"
  }
}
```

#### 3.3. POST `/api/v1/tools`
**Method:** POST  
**Deskripsi:** Membuat tool baru

**Request Body Baru:**
- `device_id` (optional): String, maksimal 255 karakter

**Response:**
- Response sekarang termasuk field `device_id` yang baru dibuat

**Contoh Request & Response:**

**Request (dengan device_id):**
```
POST /api/v1/tools
Content-Type: application/json
Authorization: Bearer {token}

{
  "tool_name": "Digital Caliper",
  "tool_model": "DC-2000",
  "tool_type": "MECHANICAL",
  "imei": "IMEI-789012",
  "device_id": "DEVICE-002",
  "status": "ACTIVE"
}
```

**Response:**
```json
{
  "http_code": 201,
  "message": "Tool created successfully",
  "error_id": null,
  "data": {
    "id": 2,
    "tool_name": "Digital Caliper",
    "tool_model": "DC-2000",
    "tool_type": "MECHANICAL",
    "tool_type_description": "Mechanical Tool",
    "last_calibration_at": null,
    "next_calibration_at": null,
    "imei": "IMEI-789012",
    "device_id": "DEVICE-002",
    "status": "ACTIVE",
    "status_description": "Active",
    "created_at": "2026-01-17T10:00:00.000000Z",
    "updated_at": "2026-01-17T10:00:00.000000Z"
  }
}
```

**Catatan:** `device_id` adalah required field, jadi request tanpa `device_id` akan menghasilkan validation error.

#### 3.4. PUT `/api/v1/tools/{id}`
**Method:** PUT  
**Deskripsi:** Update tool yang sudah ada

**Request Body Baru:**
- `device_id` (optional): String, maksimal 255 karakter (optional karena update bisa partial)

**Response:**
- Response sekarang termasuk field `device_id` yang sudah diupdate

**Contoh Request & Response:**

**Request (update device_id):**
```
PUT /api/v1/tools/1
Content-Type: application/json
Authorization: Bearer {token}

{
  "device_id": "DEVICE-UPDATED-001"
}
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Tool updated successfully",
  "error_id": null,
  "data": {
    "id": 1,
    "tool_name": "Digital Caliper",
    "tool_model": "DC-2000",
    "tool_type": "MECHANICAL",
    "tool_type_description": "Mechanical Tool",
    "last_calibration_at": "2025-12-01",
    "next_calibration_at": "2026-06-01",
    "imei": "IMEI-123456",
    "device_id": "DEVICE-UPDATED-001",
    "status": "ACTIVE",
    "status_description": "Active",
    "created_at": "2025-01-15T10:30:00.000000Z",
    "updated_at": "2026-01-17T10:10:00.000000Z"
  }
}
```

**Catatan:** `device_id` tidak bisa di-set ke null karena field ini required di database. Update hanya bisa mengubah nilai `device_id` ke nilai string lain, bukan null.

#### 3.5. GET `/api/v1/tools/overdue-calibration`
**Method:** GET  
**Deskripsi:** Mendapatkan tools yang overdue calibration

**Perubahan:**
- Response sekarang termasuk field `deviceId` (camelCase untuk konsistensi dengan response format endpoint ini)

**Response Field Baru:**
- `deviceId`: String, required

**Contoh Request & Response:**

**Request:**
```
GET /api/v1/tools/overdue-calibration?date=2026-01-17
```

**Response:**
```json
{
  "http_code": 200,
  "message": "Overdue calibration tools retrieved successfully",
  "error_id": null,
  "data": [
    {
      "id": 1,
      "toolName": "Digital Caliper",
      "toolModel": "DC-2000",
      "toolType": "MECHANICAL",
      "toolTypeDescription": "Mechanical Tool",
      "lastCalibration": "2025-12-01T00:00:00.000000Z",
      "nextCalibration": "2026-01-10T00:00:00.000000Z",
      "imei": "IMEI-123456",
      "deviceId": "DEVICE-001",
      "status": "ACTIVE",
      "statusDescription": "Active",
      "createdAt": "2025-01-15T10:30:00.000000Z",
      "updatedAt": "2026-01-17T08:00:00.000000Z"
    }
  ]
}
```

**Catatan:** Field `deviceId` menggunakan camelCase untuk konsistensi dengan format response endpoint ini (bukan snake_case seperti endpoint lainnya)

### Database Migration
- Migration file: `2026_01_17_100000_add_device_id_to_tools_table.php`
- Kolom `device_id` ditambahkan ke tabel `tools` dengan tipe `string` (required, tidak nullable)
- Posisi kolom: setelah kolom `imei`
- **Auto-fill untuk existing data:** Migration akan otomatis mengisi `device_id` untuk tools yang sudah ada dengan format `DEVICE-{imei}`

### Catatan Penting
- Field `device_id` **required** saat create tool baru (POST `/api/v1/tools`)
- Field `device_id` optional saat update tool (PUT `/api/v1/tools/{id}`) karena update bisa partial
- Field ini berbeda dengan `imei` - `imei` tetap required dan unique, sedangkan `device_id` adalah identifier tambahan yang juga required
- Saat melakukan search di endpoint GET `/api/v1/tools`, pencarian akan mencakup `device_id` juga
- **Migration Safety:** Migration akan otomatis mengisi `device_id` untuk tools existing dengan format `DEVICE-{imei}`, jadi tidak perlu manual update

---

## Testing Recommendations

### 1. Testing `/reports/data` dengan SKIP_CHECK
- Test dengan product yang memiliki measurement items dengan `evaluation_type` = `SKIP_CHECK`
- Pastikan `summary.todo` tidak menghitung item SKIP_CHECK meskipun statusnya `null`
- Verifikasi bahwa item SKIP_CHECK tetap muncul di `measurement_items` dengan status `null`

### 2. Testing Filter `category_id` dan `query`
- Test semua tiga endpoint `available-products` dengan parameter `category_id`
- Test dengan parameter `query` untuk memastikan pencarian bekerja dengan baik
- Test kombinasi `category_id` dan `query` bersamaan
- Pastikan behavior existing tetap bekerja jika parameter baru tidak digunakan

### 3. Testing `device_id` pada Tools
- Test create tool baru dengan `device_id`
- Test update tool existing dengan `device_id`
- Test search dengan `device_id`
- Pastikan tools yang sudah ada (tanpa `device_id`) tetap berfungsi normal
- Verifikasi semua endpoint tools mengembalikan `device_id` di response

---

## Migration Instructions

Untuk menerapkan perubahan database (penambahan `device_id` pada tabel `tools`), jalankan migration:

```bash
php artisan migrate
```

Migration file yang akan dijalankan:
- `2026_01_17_100000_add_device_id_to_tools_table.php`

**Catatan:** 
- Pastikan untuk backup database sebelum menjalankan migration
- Migration akan otomatis mengisi `device_id` untuk tools yang sudah ada dengan format `DEVICE-{imei}`
- Setelah migration, semua tools (existing dan baru) akan memiliki `device_id` yang required

---

## Breaking Changes

Tidak ada breaking changes pada update ini. Semua perubahan bersifat backward compatible:
- Parameter baru (`category_id`, `query`, `device_id`) bersifat optional
- Response structure tetap sama, hanya menambahkan field baru
- Behavior existing tetap sama jika parameter baru tidak digunakan

---

## Summary

1. ✅ Fixed: `/reports/data` endpoint sekarang tidak menghitung SKIP_CHECK items sebagai todo
2. ✅ Added: Filter `category_id` dan search `query` pada 3 endpoint `available-products`
3. ✅ Added: Field `device_id` pada semua endpoint tools (CRUD operations)

Semua perubahan telah diimplementasikan dan siap untuk testing.
